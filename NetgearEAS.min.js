javascript:const UPDATE_MS=2e3,SIZE_KB=1024,SIZE_MB=1048576;let mode="",history={sinr:[],rsrp:[],rsrq:[],rscp:[],ecio:[],dl:0,ul:0,dlultime:0,dlul:[]},boxcar=85,gt=3,gw=boxcar*(gt+1),gh=30,ghd=1.75*gh;function formatBandwidth(bytesPerSec){bytesPerSec*=8;return bytesPerSec<SIZE_KB?bytesPerSec+"bit/s":bytesPerSec<SIZE_MB?(bytesPerSec/SIZE_KB).toFixed(2)+"KBit/s":(bytesPerSec/SIZE_MB).toFixed(2)+"MBit/s"}function getModeDescription(mode){switch(mode){case"WcdmaService":return"WCDMA";case"LteService":return"LTE"}return"Unknown mode"}function setParam(param,val){try{document.getElementById(param).innerHTML=val}catch(param){}}function setVisible(id,visible){document.getElementById(id).style.display=visible?"block":"none"}function setMode(newMode){if(mode!==newMode){for(var k in mode=newMode,console.log("Network mode set to",mode),setVisible("status_3g",!1),setVisible("status_lte",!1),history)history[k]=Array.isArray(history[k])?[]:0;"WCDMA"===mode?setVisible("status_3g",!0):"LTE"===mode&&setVisible("status_lte",!0)}}function barGraph(p,val,min,max){(val=max<val?max:val)<min&&(val=min),history[p].unshift(val),history[p].length>boxcar&&history[p].pop();let html=`<svg version="1.1" viewBox="0 0 ${gw} ${gh}" width="${gw}" height="${gh}" preserveAspectRatio="xMaxYMax slice" style="border:1px solid #ccc;padding:1px;margin-top:-6px;width:${gw}px;">`;for(let x=0;x<history[p].length;x++){var pax=(gt+1)*(x+1),pay=gh-1;let pby=gh-(history[p][x]-min)/(max-min)*gh;isNaN(pby)&&(pby=pay);var pc=(history[p][x]-min)/(max-min)*100;html+=`<line x1="${pax}" y1="${pay}" x2="${pax}" y2="${pby}" stroke="${pc<50?"red":pc<85?"orange":"green"}" stroke-width="${gt}"></line>`}html+="</svg>",document.getElementById("b"+p).innerHTML=html}function nearestFib(x){let f1=0,f2=1,fn=0;for(let n=1;n<20&&!(x<(fn=f1+f2));n++)f2=f1,f1=fn;return fn}function barGraphDlUl(p,valDl,valUl){history[p].unshift([8*valDl,8*valUl]),history[p].length>boxcar&&history[p].pop();var valDl=history[p].reduce((accum,current)=>[Math.max(accum[0],current[0]),Math.max(accum[1],current[1])]),valUl=nearestFib(Math.max(valDl[0],valDl[1])/SIZE_MB),maxPlot=valUl*SIZE_MB;let html=`<svg version="1.1" viewBox="0 0 ${gw} ${ghd}" width="${gw}" height="${ghd}" preserveAspectRatio="xMaxYMax slice" style="border:1px solid #ccc;padding:1px;margin-top:-6px;width:${gw}px;">`;for(let x=0;x<history[p].length;x++){var dl=history[p][x][0],ul=history[p][x][1],pax=(gt+1)*(x+1),pay=ghd-1,pbyDl=ghd*(1-dl/maxPlot),pbyUl=ghd*(1-ul/maxPlot);let pby1=pay,pby2=pay,color2="grey";color2=ul<dl?(pby1=pbyUl,pby2=pbyDl,"#332288"):(pby1=pbyDl,pby2=pbyUl,"#88CCEE"),html=(html+=`<line x1="${pax}" y1="${pay}" x2="${pax}" y2="${pby1}" stroke="#DDCC77" stroke-width="${gt}"></line>`)+`<line x1="${pax}" y1="${pby1}" x2="${pax}" y2="${pby2}" stroke="${color2}" stroke-width="${gt}"></line>`}html=html+`<text x="${gw}" y="6" dominant-baseline="hanging" text-anchor="end" style="fill:gray;">${valUl.toFixed(0)}MBit/s</text>`+"</svg>",document.getElementById("b"+p).innerHTML=html}function currentBand(){$.ajax({type:"GET",async:!0,url:"/api/model.json?internalapi=1",error:function(request,status,error){console.log("Error: Cannot get Signal data:",request.status,"\nmessage:",request.responseText,"\nerror:",error)},success:function(data){data=JSON.parse(data);if(data){var currentMode=getModeDescription(data.wwan.currentNWserviceType),fullMode=currentMode+(0===data.wwan.ca.SCCcount?"":"-A");let report="Network mode : "+fullMode;setParam("mode",fullMode),setMode(currentMode);var dlRate,dlRateStr,ulRateStr,fullMode=data.wwan.signalStrength.rssi,fullMode=(report+=`\nRSSI : ${fullMode}dBm`,setParam("rssi",fullMode+"dBm"),"WCDMA"===mode?(currentMode=data.wwan.signalStrength.rscp,fullMode=data.wwan.signalStrength.ecio,report+=`\nRSCP : ${currentMode}dBm EC/IO : ${fullMode}dB`,setParam("rscp",currentMode+"dBm"),barGraph("rscp",currentMode,-100,-70),setParam("ecio",fullMode+"dB"),barGraph("ecio",fullMode,-10,-2)):"LTE"===mode&&(currentMode=data.wwan.signalStrength.rsrq,fullMode=data.wwan.signalStrength.rsrp,sinr=data.wwan.signalStrength.sinr,report+=`\nRSRQ/RSRP/SINR : ${currentMode}dB/${fullMode}dBm/${sinr}dB`,setParam("rsrp",fullMode+"dBm"),barGraph("rsrp",fullMode,-130,-60),setParam("rsrq",currentMode+"dB"),barGraph("rsrq",currentMode,-16,-3),setParam("sinr",sinr+"dB"),barGraph("sinr",sinr,0,24)),data.wwan.dataTransferredRx),currentMode=data.wwan.dataTransferredTx,sinr=(new Date).getTime();0!==history.dlultime&&(data=1e3/(sinr-history.dlultime),dlRate=0===history.dl?0:Math.floor((fullMode-history.dl)*data),data=0===history.ul?0:Math.floor((currentMode-history.ul)*data),dlRateStr=formatBandwidth(dlRate),ulRateStr=formatBandwidth(data),report+=`\nDownload : ${dlRateStr} Upload : `+ulRateStr,setParam("dl",dlRateStr),setParam("ul",ulRateStr),barGraphDlUl("dlul",dlRate,data),history.dl=fullMode,history.ul=currentMode),history.dlultime=sinr,console.log(report)}}})}function statusHeader(){document.body.insertAdjacentHTML("afterbegin",'<style>#mode,#rssi,#rscp,#ecio,#rsrq,#rsrp,#sinr,#ul,#dl{color:#b00;font-weight:strong;}.f{float:left;border:1px solid #bbb;border-radius:5px;padding:10px;line-height:2em;margin:5px;}.f ul{margin:0;padding:0;}.f ul li{display:inline;margin-right:10px;}</style><div style="display:block;overflow:auto;"><div class="f" id="status_general"><ul><li>Network mode:<span id="mode">#</span></li><li>RSSI:<span id="rssi">#</span></li></ul></div><div class="f" id="status_3g">RSCP:<span id="rscp">#</span><div id="brscp"></div>EC/IO:<span id="ecio">#</span><div id="becio"></div></div><div class="f" id="status_lte">RSRQ:<span id="rsrq">#</span><div id="brsrq"></div>RSRP:<span id="rsrp">#</span><div id="brsrp"></div>SINR:<span id="sinr">#</span><div id="bsinr"></div></div><div class="f" id="bandwidth"><ul><li>Download:<span id="dl">#</span></li><li>Upload:<span id="ul">#</span></li></ul><div id="bdlul"></div></div></div>'),setInterval(currentBand,UPDATE_MS)}statusHeader();